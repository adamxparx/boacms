{% extends 'accounts/dashboard.html' %}
{% load static %}

{% block title %}Certification Request Form | Barangay OACMS{% endblock %}

{% block content %}

<div class="certification-block">
  <div class="options tabs" role="tablist" aria-label="Certification Types">
    <a href="{% url 'barangay_clearance' %}" class="tab" {% if request.resolver_match.url_name == 'barangay_clearance' %}aria-current="page"{% endif %}>Barangay Clearance</a>
    <a href="{% url 'indigency_certificate' %}" class="tab" {% if request.resolver_match.url_name == 'indigency_certificate' %}aria-current="page"{% endif %}>Certificate of Indigency</a>
    <a href="{% url 'comm_tax_cert' %}" class="tab" {% if request.resolver_match.url_name == 'comm_tax_cert' %}aria-current="page"{% endif %}>Community Tax Certificate (Cedula)</a>
    <a href="{% url 'solo_parent_cert' %}" class="tab" {% if request.resolver_match.url_name == 'solo_parent_cert' %}aria-current="page"{% endif %}>Solo Parent Certificate</a>
  </div>

  <div class="cert_content">
    {% block cert_content %}{% endblock %}
  </div>
</div>

<script>
  (function() {
    const MIN = "09:00";
    const MAX = "16:30";

    function setConstraints() {
      const timeInputs = document.querySelectorAll('input[type="time"], input[name$="appointment_time"]');
      timeInputs.forEach(inp => {
        try { inp.min = MIN; inp.max = MAX; } catch(e) {}
        inp.addEventListener('change', () => validateTime(inp));
        inp.addEventListener('input', () => inp.setCustomValidity(''));
      });
    }

    function parseTime(val) {
      if (!val) return null;
      const parts = val.split(":").map(Number);
      if (parts.length < 2) return null;
      return parts[0] * 60 + parts[1];
    }

    function validateTime(input) {
      const v = parseTime(input.value);
      const min = parseTime(MIN);
      const max = parseTime(MAX);
      if (v == null) return true;
      if (v < min || v > max) {
        input.setCustomValidity(`Please select a time between ${MIN} and ${MAX}.`);
        input.reportValidity();
        return false;
      } else {
        input.setCustomValidity('');
        return true;
      }
    }

    function attachFormGuards() {
      const forms = document.querySelectorAll('.auth-form, .cert');
      forms.forEach(form => {
        form.addEventListener('submit', (e) => {
          const timeInputs = form.querySelectorAll('input[type="time"], input[name$="appointment_time"]');
          let ok = true;
          timeInputs.forEach(inp => { if (!validateTime(inp)) ok = false; });
          if (!ok) {
            e.preventDefault();
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setConstraints();
      attachFormGuards();
    });
  })();
</script>

<script>
  (function() {
    function todayStr() {
      const d = new Date();
      d.setHours(0,0,0,0);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function setDateConstraints() {
      const min = todayStr();
      const dateInputs = document.querySelectorAll('input[type="date"], input[name$="appointment_date"]');
      dateInputs.forEach(inp => {
        try { inp.min = min; } catch(e) {}
        inp.addEventListener('change', () => validateDate(inp));
        inp.addEventListener('input', () => inp.setCustomValidity(''));
      });
    }

    function validateDate(input) {
      if (!input.value) return true;
      const min = input.min || todayStr();
      if (input.value < min) {
        input.setCustomValidity('Please select today or a future date.');
        input.reportValidity();
        return false;
      }
      input.setCustomValidity('');
      return true;
    }

    function attachDateGuards() {
      const forms = document.querySelectorAll('.auth-form, .cert');
      forms.forEach(form => {
        form.addEventListener('submit', (e) => {
          const dateInputs = form.querySelectorAll('input[type="date"], input[name$="appointment_date"]');
          let ok = true;
          dateInputs.forEach(inp => { if (!validateDate(inp)) ok = false; });
          if (!ok) e.preventDefault();
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setDateConstraints();
      attachDateGuards();
    });
  })();
</script>

{% endblock %}
